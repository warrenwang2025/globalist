<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Prompt Studio - Media Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .message-user { background: #f3f4f6; }
        .message-ai { background: #e5f3ff; }
        .status-valid { background: #dcfce7; color: #166534; }
        .status-invalid { background: #fef2f2; color: #dc2626; }
        .chat-container { height: 500px; overflow-y: auto; }
        .system-prompt { min-height: 120px; }
        .resize-handle { cursor: ns-resize; }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="max-w-6xl mx-auto p-6">
        <!-- Header -->
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">AI Prompt Studio</h1>
            <p class="text-gray-600">Test AI prompts for Media Suite - Similar to Google AI Studio</p>
        </div>

        <!-- Tool Selection -->
        <div class="bg-white rounded-lg shadow-sm border mb-4 p-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Tool Type</label>
            <div class="flex gap-2 flex-wrap">
                <button onclick="selectTool('ideas')" class="tool-btn px-4 py-2 rounded-md border hover:bg-gray-50" data-tool="ideas">IDEAS (5)</button>
                <button onclick="selectTool('headlines')" class="tool-btn px-4 py-2 rounded-md border hover:bg-gray-50" data-tool="headlines">HEADLINES (8)</button>
                <button onclick="selectTool('summarize')" class="tool-btn px-4 py-2 rounded-md border hover:bg-gray-50" data-tool="summarize">SUMMARIZE (1)</button>
                <button onclick="selectTool('improve')" class="tool-btn px-4 py-2 rounded-md border hover:bg-gray-50" data-tool="improve">IMPROVE (blocks)</button>
                <button onclick="selectTool('seo')" class="tool-btn px-4 py-2 rounded-md border hover:bg-gray-50" data-tool="seo">SEO (blocks)</button>
            </div>
        </div>

        <!-- System Prompt -->
        <div class="bg-white rounded-lg shadow-sm border mb-4">
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800">System Prompt</h2>
                <p class="text-sm text-gray-600">Define the AI's role and behavior</p>
            </div>
            <div class="p-4">
                <textarea 
                    id="systemPrompt" 
                    class="w-full system-prompt p-3 border rounded-md font-mono text-sm resize-y"
                    placeholder="Enter system prompt..."
                    onchange="autoSaveCurrentPrompts()"
                    oninput="debouncedAutoSave()"
                ></textarea>
            </div>
        </div>

        <!-- User Prompt Template -->
        <div class="bg-white rounded-lg shadow-sm border mb-4">
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800">User Prompt Template</h2>
                <p class="text-sm text-gray-600">Define how the user prompt is structured (editable by prompt engineer)</p>
            </div>
            <div class="p-4">
                <textarea 
                    id="userPromptTemplate" 
                    class="w-full system-prompt p-3 border rounded-md font-mono text-sm resize-y"
                    placeholder="Enter user prompt template..."
                    onchange="autoSaveCurrentPrompts()"
                    oninput="debouncedAutoSave()"
                ></textarea>
                <div class="mt-2 text-xs text-gray-500">
                    Variables: {topic}, {tone_context}, {raw_content}, {content_blocks_json}
                </div>
            </div>
        </div>

        <!-- Tone Context Editor -->
        <div class="bg-white rounded-lg shadow-sm border mb-4">
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800">Tone Context</h2>
                <p class="text-sm text-gray-600">Define the tone and style context for content generation</p>
            </div>
            <div class="p-4">
                <input 
                    type="text" 
                    id="toneContext" 
                    class="w-full p-3 border rounded-md text-sm"
                    placeholder="e.g., professional and engaging, casual and friendly, formal and authoritative"
                    value="professional and engaging"
                    onchange="autoSaveCurrentPrompts()"
                    oninput="debouncedAutoSave()"
                >
                <div class="mt-2 text-xs text-gray-500">
                    This value will replace {tone_context} in your prompt templates
                </div>
            </div>
        </div>

        <!-- Content Block Generator (for IMPROVE/SEO tools) -->
        <div id="contentBlockGenerator" class="bg-white rounded-lg shadow-sm border mb-4 hidden">
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800">Content Block Generator</h2>
                <p class="text-sm text-gray-600">Create custom content blocks for IMPROVE/SEO testing</p>
            </div>
            <div class="p-4">
                <div class="space-y-4">
                    <div class="flex gap-2 mb-4">
                        <button onclick="addBlock('heading')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-md text-sm hover:bg-blue-200">+ Heading</button>
                        <button onclick="addBlock('text')" class="px-3 py-1 bg-green-100 text-green-700 rounded-md text-sm hover:bg-green-200">+ Text</button>
                        <button onclick="addBlock('quote')" class="px-3 py-1 bg-purple-100 text-purple-700 rounded-md text-sm hover:bg-purple-200">+ Quote</button>
                        <button onclick="addBlock('list')" class="px-3 py-1 bg-orange-100 text-orange-700 rounded-md text-sm hover:bg-orange-200">+ List</button>
                        <button onclick="clearBlocks()" class="px-3 py-1 bg-red-100 text-red-700 rounded-md text-sm hover:bg-red-200">Clear All</button>
                    </div>
                    <div id="blockEditor" class="space-y-3 border rounded-md p-3 bg-gray-50 min-h-[100px]">
                        <p class="text-gray-500 text-sm">Click buttons above to add content blocks</p>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Generated JSON (verify manually)</label>
                        <textarea 
                            id="generatedJson" 
                            class="w-full h-32 p-3 border rounded-md font-mono text-xs bg-gray-50"
                            readonly
                            placeholder="Generated content blocks will appear here..."
                        ></textarea>
                        <div class="mt-2 flex gap-2">
                            <button onclick="validateGeneratedJson()" class="px-3 py-1 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700">Validate Structure</button>
                            <span id="jsonValidationStatus" class="text-sm"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Documentation for Content Blocks -->
        <div id="contentBlockDocs" class="bg-white rounded-lg shadow-sm border mb-4 hidden">
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800">üìã Content Blocks Documentation</h2>
                <p class="text-sm text-gray-600">Detailed structure for IMPROVE/SEO tools</p>
            </div>
            <div class="p-4 space-y-6">
                <!-- Request Structure -->
                <div>
                    <h3 class="text-md font-semibold text-gray-700 mb-3">üì§ Request Structure (Input)</h3>
                    <div class="bg-gray-50 rounded-md p-4">
                        <p class="text-sm text-gray-600 mb-2">The LLM receives content blocks as JSON array via <code class="bg-gray-200 px-1 rounded">{content_blocks_json}</code> variable:</p>
                        <pre class="text-xs bg-white p-3 rounded border font-mono overflow-x-auto"><code>[
  {
    "type": "heading",
    "content": "Marketing Strategy",
    "level": 2
  },
  {
    "type": "text",
    "content": "This is a paragraph of text content."
  },
  {
    "type": "quote",
    "content": "Innovation distinguishes between a leader and a follower.",
    "author": "Steve Jobs"
  },
  {
    "type": "list",
    "content": ["Item 1", "Item 2", "Item 3"],
    "ordered": false
  }
]</code></pre>
                    </div>
                </div>

                <!-- Response Structure -->
                <div>
                    <h3 class="text-md font-semibold text-gray-700 mb-3">üì§ Response Structure (Output)</h3>
                    <div class="bg-gray-50 rounded-md p-4">
                        <p class="text-sm text-gray-600 mb-2">The LLM must return a JSON array of enhanced/optimized content blocks:</p>
                        <pre class="text-xs bg-white p-3 rounded border font-mono overflow-x-auto"><code>[
  {
    "type": "heading",
    "content": "Enhanced Marketing Strategy for 2025",
    "level": 1
  },
  {
    "type": "text",
    "content": "Modern marketing requires a strategic approach that combines digital innovation with customer-centric messaging to achieve sustainable business growth."
  },
  {
    "type": "quote",
    "content": "The best marketing doesn't feel like marketing.",
    "author": "Tom Fishburne"
  },
  {
    "type": "list",
    "content": ["Social media engagement", "SEO optimization", "Content marketing", "Email campaigns"],
    "ordered": true
  }
]</code></pre>
                    </div>
                </div>

                <!-- Block Types -->
                <div>
                    <h3 class="text-md font-semibold text-gray-700 mb-3">üîß Block Types & Requirements</h3>
                    <div class="space-y-3">
                        <div class="bg-blue-50 rounded-md p-3">
                            <h4 class="font-medium text-blue-800 mb-2">üìù Heading Block</h4>
                            <pre class="text-xs bg-white p-2 rounded border font-mono"><code>{
  "type": "heading",
  "content": "Your heading text",
  "level": 1-6  // Required: H1=1, H2=2, etc.
}</code></pre>
                        </div>
                        <div class="bg-green-50 rounded-md p-3">
                            <h4 class="font-medium text-green-800 mb-2">üìÑ Text Block</h4>
                            <pre class="text-xs bg-white p-2 rounded border font-mono"><code>{
  "type": "text",
  "content": "Your paragraph text content"
}</code></pre>
                        </div>
                        <div class="bg-purple-50 rounded-md p-3">
                            <h4 class="font-medium text-purple-800 mb-2">üí¨ Quote Block</h4>
                            <pre class="text-xs bg-white p-2 rounded border font-mono"><code>{
  "type": "quote",
  "content": "The quote text",
  "author": "Author Name"  // Optional
}</code></pre>
                        </div>
                        <div class="bg-orange-50 rounded-md p-3">
                            <h4 class="font-medium text-orange-800 mb-2">üìã List Block</h4>
                            <pre class="text-xs bg-white p-2 rounded border font-mono"><code>{
  "type": "list",
  "content": ["Item 1", "Item 2", "Item 3"],  // Array required
  "ordered": false  // true for numbered, false for bullets
}</code></pre>
                        </div>
                    </div>
                </div>

                <!-- Validation Rules -->
                <div>
                    <h3 class="text-md font-semibold text-gray-700 mb-3">‚úÖ Validation Rules</h3>
                    <div class="bg-yellow-50 rounded-md p-4">
                        <ul class="text-sm text-gray-700 space-y-1">
                            <li>‚Ä¢ Response must be a valid JSON array</li>
                            <li>‚Ä¢ Each block must have a <code class="bg-gray-200 px-1 rounded">type</code> field</li>
                            <li>‚Ä¢ Each block must have a <code class="bg-gray-200 px-1 rounded">content</code> field</li>
                            <li>‚Ä¢ Valid types: "heading", "text", "quote", "list"</li>
                            <li>‚Ä¢ Heading blocks must have <code class="bg-gray-200 px-1 rounded">level</code> (1-6)</li>
                            <li>‚Ä¢ List blocks must have <code class="bg-gray-200 px-1 rounded">content</code> as array</li>
                            <li>‚Ä¢ List blocks must have <code class="bg-gray-200 px-1 rounded">ordered</code> boolean</li>
                            <li>‚Ä¢ Quote blocks can have optional <code class="bg-gray-200 px-1 rounded">author</code> field</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration -->
        <div class="bg-white rounded-lg shadow-sm border mb-4">
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800">Configuration & Storage</h2>
                <p class="text-sm text-gray-600">Configure OpenAI API and manage prompt storage</p>
            </div>
            <div class="p-4">
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">OpenAI API Key</label>
                    <input 
                        type="password" 
                        id="apiKey" 
                        placeholder="sk-..." 
                        class="w-full p-2 border rounded-md text-sm"
                        onchange="saveApiKey()"
                    >
                    <p class="text-xs text-gray-500 mt-1">Your API key is stored locally in your browser only</p>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Model</label>
                    <select id="modelSelect" class="p-2 border rounded-md text-sm">
                        <option value="gpt-4o-mini">GPT-4o Mini (Recommended)</option>
                        <option value="gpt-4o">GPT-4o</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    </select>
                </div>
                <div class="flex items-center gap-2 mb-3">
                    <span id="apiStatus" class="text-sm text-gray-500">API Key not configured</span>
                    <button onclick="testApiConnection()" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-md text-sm hover:bg-blue-200" id="testApiBtn">Test API</button>
                </div>
                <div class="border-t pt-3">
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Prompt Storage</h3>
                    <div class="flex items-center gap-2 flex-wrap">
                        <span id="storageStatus" class="text-sm text-gray-500">No saved prompts</span>
                        <button onclick="savePromptsToFile()" class="px-3 py-1 bg-green-100 text-green-700 rounded-md text-sm hover:bg-green-200" id="saveFileBtn">üíæ Save to File</button>
                        <button onclick="triggerLoadFile()" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-md text-sm hover:bg-blue-200" id="loadFileBtn">üìÅ Load from File</button>
                        <input type="file" id="fileInput" accept=".json" style="display: none" onchange="loadPromptsFromFile(event)">
                        <button onclick="savePromptsToLocal()" class="px-3 py-1 bg-purple-100 text-purple-700 rounded-md text-sm hover:bg-purple-200" id="saveLocalBtn">üíæ Save Local</button>
                        <button onclick="loadPromptsFromLocal()" class="px-3 py-1 bg-orange-100 text-orange-700 rounded-md text-sm hover:bg-orange-200" id="loadLocalBtn">üì± Load Local</button>
                        <button onclick="clearStoredPrompts()" class="px-3 py-1 bg-red-100 text-red-700 rounded-md text-sm hover:bg-red-200" id="clearBtn">üóëÔ∏è Clear</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">üíæ File: Download/upload .json files ‚Ä¢ üíæ Local: Browser storage ‚Ä¢ üì± Auto-loads local storage on startup</p>
                </div>
            </div>
        </div>

        <!-- Chat Interface -->
        <div class="bg-white rounded-lg shadow-sm border">
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800">Chat Interface</h2>
                <p class="text-sm text-gray-600">Test your prompts against real LLM and see validation results</p>
            </div>
            
            <!-- Chat Messages -->
            <div id="chatContainer" class="chat-container p-4 space-y-4">
                <div class="text-center text-gray-500 py-8">
                    <p>Select a tool type and start chatting to test your prompts!</p>
                    <p class="text-sm mt-2">Messages will appear here with validation status</p>
                </div>
            </div>

            <!-- Input Area -->
            <div class="border-t p-4">
                <div class="flex gap-3">
                    <textarea 
                        id="userInput" 
                        placeholder="Enter your test prompt here... (e.g., 'Generate ideas about social media marketing')"
                        class="flex-1 p-3 border rounded-md resize-none"
                        rows="2"
                        onkeydown="handleKeyDown(event)"
                    ></textarea>
                    <button 
                        onclick="sendMessage()" 
                        class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400"
                        id="sendBtn"
                    >
                        Send
                    </button>
                </div>
                <div class="mt-2 text-xs text-gray-500">
                    Press Ctrl+Enter to send ‚Ä¢ Current tool: <span id="currentToolDisplay">None</span>
                </div>
            </div>
        </div>

        <!-- Quick Examples -->
        <div class="mt-4 bg-white rounded-lg shadow-sm border p-4">
            <h3 class="font-semibold text-gray-800 mb-2">Quick Examples</h3>
            <div class="flex gap-2 flex-wrap" id="exampleButtons">
                <button onclick="setExample('Generate 5 content ideas about digital marketing')" class="px-3 py-1 text-sm bg-gray-100 rounded-md hover:bg-gray-200">Ideas Example</button>
                <button onclick="setExample('Create 8 headlines for a fitness blog')" class="px-3 py-1 text-sm bg-gray-100 rounded-md hover:bg-gray-200">Headlines Example</button>
                <button onclick="setExample('Summarize this: Social media helps businesses connect with customers and build brand awareness through regular posting and engagement.')" class="px-3 py-1 text-sm bg-gray-100 rounded-md hover:bg-gray-200">Summarize Example</button>
            </div>
        </div>
    </div>

    <script>
        // Default system prompts for each tool
        const systemPrompts = {
            ideas: "You are a creative content strategist. Generate original, engaging content ideas.",
            headlines: "You are a skilled copywriter. Create compelling, attention-grabbing headlines.",
            summarize: "You are a professional editor. Create clear, concise summaries that capture key points.",
            improve: "You are a writing coach. Enhance content while maintaining its original structure and meaning.",
            seo: "You are an SEO specialist. Optimize content for search engines while keeping it readable and engaging."
        };

        // User prompt templates (editable by prompt engineer)
        const userPromptTemplates = {
            ideas: 'Generate 5 creative content ideas about: "{topic}"{tone_context}\n\nReturn ONLY a valid JSON array of strings:\n["idea 1", "idea 2", "idea 3", "idea 4", "idea 5"]',
            headlines: 'Create 8 compelling headlines about: "{topic}"{tone_context}\n\nReturn ONLY a valid JSON array of strings:\n["headline 1", "headline 2", "headline 3", "headline 4", "headline 5", "headline 6", "headline 7", "headline 8"]',
            summarize: 'Summarize the following content{tone_context}:\n\n{raw_content}\n\nReturn ONLY a JSON array with a single summary string:\n["Your comprehensive summary here"]',
            improve: 'Improve and enhance the following content{tone_context}.\n\nYou can restructure, combine, split, or reorganize the content as needed for better readability and impact.\nYou may change the number of blocks and their types to improve the content structure.\n\nInput content blocks:\n{content_blocks_json}\n\nReturn ONLY a valid JSON array of enhanced content blocks. Each block must have:\n- type: "heading" | "text" | "quote" | "list"\n- content: string (or array of strings for lists)\n- level: number (1-6, only for headings)\n- author: string (only for quotes)\n- ordered: boolean (only for lists)\n\nExample valid block types:\n{"type": "heading", "content": "Enhanced Title", "level": 2}\n{"type": "text", "content": "Enhanced paragraph text"}\n{"type": "quote", "content": "Enhanced quote", "author": "Author Name"}\n{"type": "list", "content": ["Item 1", "Item 2"], "ordered": false}\n\nReturn the enhanced content as a valid JSON array:',
            seo: 'Optimize for SEO the following content{tone_context}.\n\nYou can restructure, combine, split, or reorganize the content as needed for better search engine visibility and user engagement.\nYou may change the number of blocks and their types to improve the content structure.\n\nInput content blocks:\n{content_blocks_json}\n\nReturn ONLY a valid JSON array of SEO-optimized content blocks. Each block must have:\n- type: "heading" | "text" | "quote" | "list"\n- content: string (or array of strings for lists)\n- level: number (1-6, only for headings)\n- author: string (only for quotes)\n- ordered: boolean (only for lists)\n\nExample valid block types:\n{"type": "heading", "content": "SEO-Optimized Title with Keywords", "level": 2}\n{"type": "text", "content": "SEO-enhanced paragraph with relevant keywords"}\n{"type": "quote", "content": "Optimized quote", "author": "Author Name"}\n{"type": "list", "content": ["Keyword-rich item 1", "Keyword-rich item 2"], "ordered": false}\n\nReturn the SEO-optimized content as a valid JSON array:'
        };

        let currentTool = null;
        let messageCount = 0;
        let contentBlocks = [];

        // Tool selection
        function selectTool(toolType) {
            currentTool = toolType;
            
            // Update UI
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('border');
            });
            
            const selectedBtn = document.querySelector(`[data-tool="${toolType}"]`);
            selectedBtn.classList.add('bg-blue-600', 'text-white');
            selectedBtn.classList.remove('border');
            
            // Update prompts
            document.getElementById('systemPrompt').value = systemPrompts[toolType];
            document.getElementById('userPromptTemplate').value = userPromptTemplates[toolType];
            document.getElementById('currentToolDisplay').textContent = toolType.toUpperCase();
            
            // Show/hide content block generator
            const generator = document.getElementById('contentBlockGenerator');
            const docs = document.getElementById('contentBlockDocs');
            if (toolType === 'improve' || toolType === 'seo') {
                generator.classList.remove('hidden');
                docs.classList.remove('hidden');
                loadDefaultBlocks();
            } else {
                generator.classList.add('hidden');
                docs.classList.add('hidden');
            }
            
            // Clear chat if switching tools
            if (messageCount > 0) {
                clearChat();
            }
            
            // Auto-save when switching tools (saves current state)
            if (localStorage.getItem('ai_prompt_studio_data')) {
                savePromptsToLocal();
            }
        }

        // Content Block Generator Functions
        function addBlock(type) {
            const blockEditor = document.getElementById('blockEditor');
            const blockId = `block_${Date.now()}`;
            
            let blockHTML = '';
            
            switch (type) {
                case 'heading':
                    blockHTML = `
                        <div class="border rounded-md p-3 bg-white" data-block-id="${blockId}" data-type="heading">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-blue-700">üìù Heading</span>
                                <button onclick="removeBlock('${blockId}')" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <input type="text" placeholder="Heading text" class="w-full p-2 border rounded-md mb-2 text-sm" onchange="updateBlocks()">
                            <select class="p-2 border rounded-md text-sm" onchange="updateBlocks()">
                                <option value="1">H1</option>
                                <option value="2" selected>H2</option>
                                <option value="3">H3</option>
                                <option value="4">H4</option>
                                <option value="5">H5</option>
                                <option value="6">H6</option>
                            </select>
                        </div>
                    `;
                    break;
                case 'text':
                    blockHTML = `
                        <div class="border rounded-md p-3 bg-white" data-block-id="${blockId}" data-type="text">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-green-700">üìÑ Text</span>
                                <button onclick="removeBlock('${blockId}')" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <textarea placeholder="Text content" class="w-full p-2 border rounded-md text-sm" rows="3" onchange="updateBlocks()"></textarea>
                        </div>
                    `;
                    break;
                case 'quote':
                    blockHTML = `
                        <div class="border rounded-md p-3 bg-white" data-block-id="${blockId}" data-type="quote">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-purple-700">üí¨ Quote</span>
                                <button onclick="removeBlock('${blockId}')" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <textarea placeholder="Quote text" class="w-full p-2 border rounded-md text-sm mb-2" rows="2" onchange="updateBlocks()"></textarea>
                            <input type="text" placeholder="Author (optional)" class="w-full p-2 border rounded-md text-sm" onchange="updateBlocks()">
                        </div>
                    `;
                    break;
                case 'list':
                    blockHTML = `
                        <div class="border rounded-md p-3 bg-white" data-block-id="${blockId}" data-type="list">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-orange-700">üìã List</span>
                                <button onclick="removeBlock('${blockId}')" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <textarea placeholder="Enter list items (one per line)" class="w-full p-2 border rounded-md text-sm mb-2" rows="3" onchange="updateBlocks()"></textarea>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" class="mr-2" onchange="updateBlocks()">
                                Ordered list (numbered)
                            </label>
                        </div>
                    `;
                    break;
            }
            
            if (blockEditor.querySelector('p')) {
                blockEditor.innerHTML = '';
            }
            
            blockEditor.insertAdjacentHTML('beforeend', blockHTML);
            updateBlocks();
        }

        function removeBlock(blockId) {
            const block = document.querySelector(`[data-block-id="${blockId}"]`);
            if (block) {
                block.remove();
                updateBlocks();
                
                // Show placeholder if no blocks
                const blockEditor = document.getElementById('blockEditor');
                if (blockEditor.children.length === 0) {
                    blockEditor.innerHTML = '<p class="text-gray-500 text-sm">Click buttons above to add content blocks</p>';
                    document.getElementById('generatedJson').value = '';
                }
            }
        }

        function clearBlocks() {
            const blockEditor = document.getElementById('blockEditor');
            blockEditor.innerHTML = '<p class="text-gray-500 text-sm">Click buttons above to add content blocks</p>';
            document.getElementById('generatedJson').value = '';
            contentBlocks = [];
        }

        function updateBlocks() {
            const blockEditor = document.getElementById('blockEditor');
            const blocks = blockEditor.querySelectorAll('[data-block-id]');
            contentBlocks = [];
            
            blocks.forEach(block => {
                const type = block.dataset.type;
                const blockObj = { type };
                
                switch (type) {
                    case 'heading':
                        const headingText = block.querySelector('input').value;
                        const level = parseInt(block.querySelector('select').value);
                        if (headingText) {
                            blockObj.content = headingText;
                            blockObj.level = level;
                            contentBlocks.push(blockObj);
                        }
                        break;
                    case 'text':
                        const textContent = block.querySelector('textarea').value;
                        if (textContent) {
                            blockObj.content = textContent;
                            contentBlocks.push(blockObj);
                        }
                        break;
                    case 'quote':
                        const quoteText = block.querySelector('textarea').value;
                        const author = block.querySelector('input').value;
                        if (quoteText) {
                            blockObj.content = quoteText;
                            if (author) blockObj.author = author;
                            contentBlocks.push(blockObj);
                        }
                        break;
                    case 'list':
                        const listText = block.querySelector('textarea').value;
                        const ordered = block.querySelector('input[type="checkbox"]').checked;
                        if (listText) {
                            const items = listText.split('\n').filter(item => item.trim());
                            if (items.length > 0) {
                                blockObj.content = items;
                                blockObj.ordered = ordered;
                                contentBlocks.push(blockObj);
                            }
                        }
                        break;
                }
            });
            
            // Update JSON display
            document.getElementById('generatedJson').value = JSON.stringify(contentBlocks, null, 2);
        }

        function validateGeneratedJson() {
            const jsonText = document.getElementById('generatedJson').value;
            const statusElement = document.getElementById('jsonValidationStatus');
            
            if (!jsonText.trim()) {
                statusElement.textContent = '‚ö†Ô∏è No JSON to validate';
                statusElement.className = 'text-sm text-yellow-600';
                return;
            }
            
            try {
                const parsed = JSON.parse(jsonText);
                const validation = validateContentBlocks(parsed);
                
                if (validation.isValid) {
                    statusElement.textContent = '‚úÖ Valid structure';
                    statusElement.className = 'text-sm text-green-600';
                } else {
                    statusElement.textContent = `‚ùå ${validation.error}`;
                    statusElement.className = 'text-sm text-red-600';
                }
            } catch (error) {
                statusElement.textContent = '‚ùå Invalid JSON format';
                statusElement.className = 'text-sm text-red-600';
            }
        }

        function loadDefaultBlocks() {
            clearBlocks();
            
            // Add some default blocks for testing
            setTimeout(() => {
                addBlock('heading');
                addBlock('text');
                addBlock('list');
                
                // Fill with sample data
                const blocks = document.querySelectorAll('[data-block-id]');
                if (blocks[0]) {
                    blocks[0].querySelector('input').value = 'Marketing Tips';
                }
                if (blocks[1]) {
                    blocks[1].querySelector('textarea').value = 'Social media is important for businesses.';
                }
                if (blocks[2]) {
                    blocks[2].querySelector('textarea').value = 'Post daily\nUse hashtags';
                }
                
                updateBlocks();
            }, 100);
        }

        // Send message
        async function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            
            if (!message) return;
            if (!currentTool) {
                alert('Please select a tool type first!');
                return;
            }
            
            if (!apiKey) {
                alert('Please configure your OpenAI API key first!');
                return;
            }
            
            // Add user message
            addMessage('user', message);
            
            // Clear input
            userInput.value = '';
            
            // Call real LLM API
            await callRealLLM(message);
        }

        // Call real LLM and handle response
        async function callRealLLM(userMessage) {
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Thinking...';
            
            try {
                const systemPrompt = document.getElementById('systemPrompt').value;
                const userPromptTemplate = document.getElementById('userPromptTemplate').value;
                
                // Build the actual user prompt by replacing variables
                const finalUserPrompt = buildUserPrompt(userPromptTemplate, userMessage);
                
                // Call OpenAI API
                const aiResponse = await callOpenAI(systemPrompt, finalUserPrompt);
                
                // Validate the response
                const validation = validateResponse(currentTool, aiResponse);
                
                // Add AI response with validation
                addMessage('ai', aiResponse, validation);
                
            } catch (error) {
                console.error('API call failed:', error);
                addMessage('ai', `‚ùå API Error: ${error.message}`, { 
                    isValid: false, 
                    error: 'API call failed' 
                });
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
            }
        }

        // Add message to chat
        function addMessage(type, content, validation = null) {
            const chatContainer = document.getElementById('chatContainer');
            
            // Clear welcome message if this is the first message
            if (messageCount === 0) {
                chatContainer.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-4 rounded-lg ${type === 'user' ? 'message-user ml-12' : 'message-ai mr-12'}`;
            
            let messageHTML = `
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium ${type === 'user' ? 'bg-gray-600' : 'bg-blue-600'}">
                        ${type === 'user' ? 'U' : 'AI'}
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-sm text-gray-600 mb-1">
                            ${type === 'user' ? 'User' : 'Assistant'}
                        </div>
                        <div class="text-gray-800 whitespace-pre-wrap">${escapeHtml(content)}</div>
            `;
            
            // Add validation status for AI messages
            if (type === 'ai' && validation) {
                const statusClass = validation.isValid ? 'status-valid' : 'status-invalid';
                const statusIcon = validation.isValid ? '‚úÖ' : '‚ùå';
                const statusText = validation.isValid ? 'Valid Format' : 'Invalid Format';
                
                messageHTML += `
                    <div class="mt-3 inline-flex items-center gap-2 px-3 py-1 rounded-md text-sm font-medium ${statusClass}">
                        <span>${statusIcon}</span>
                        <span>${statusText}</span>
                        ${validation.error ? `<span class="text-xs opacity-75">- ${validation.error}</span>` : ''}
                    </div>
                `;
            }
            
            messageHTML += `
                    </div>
                </div>
            `;
            
            messageDiv.innerHTML = messageHTML;
            chatContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
            messageCount++;
        }

        // Configuration and Storage
        let apiKey = localStorage.getItem('openai_api_key') || '';
        let selectedModel = 'gpt-4o-mini';
        
        // Initialize configuration and load saved prompts
        document.addEventListener('DOMContentLoaded', function() {
            const apiKeyField = document.getElementById('apiKey');
            if (apiKeyField) {
                apiKeyField.value = apiKey;
                if (apiKey) {
                    updateApiStatus('Configured', 'success');
                }
            }
            
            // Auto-load saved prompts on startup
            loadPromptsFromLocal();
            updateStorageStatus();
        });
        
        function saveApiKey() {
            const key = document.getElementById('apiKey').value.trim();
            if (key) {
                localStorage.setItem('openai_api_key', key);
                apiKey = key;
                updateApiStatus('Configured', 'success');
            } else {
                localStorage.removeItem('openai_api_key');
                apiKey = '';
                updateApiStatus('API Key not configured', 'error');
            }
        }
        
        function updateApiStatus(message, type) {
            const statusEl = document.getElementById('apiStatus');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `text-sm ${type === 'success' ? 'text-green-600' : type === 'error' ? 'text-red-600' : 'text-gray-500'}`;
            }
        }
        
        function updateStorageStatus() {
            const statusEl = document.getElementById('storageStatus');
            const savedData = localStorage.getItem('ai_prompt_studio_data');
            
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    const saveDate = new Date(data.savedAt).toLocaleDateString();
                    statusEl.textContent = `Saved on ${saveDate}`;
                    statusEl.className = 'text-sm text-green-600';
                } catch (error) {
                    statusEl.textContent = 'Invalid saved data';
                    statusEl.className = 'text-sm text-red-600';
                }
            } else {
                statusEl.textContent = 'No saved prompts in browser storage';
                statusEl.className = 'text-sm text-gray-500';
            }
        }
        
        // Local Storage Functions
        function savePromptsToLocal() {
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;
            
            try {
                // Collect current prompts and settings
                const promptData = {
                    systemPrompts: {...systemPrompts},
                    userPromptTemplates: {...userPromptTemplates},
                    toneContext: document.getElementById('toneContext').value,
                    currentTool: currentTool,
                    savedAt: new Date().toISOString(),
                    version: '1.0'
                };
                
                // Update current tool's prompts if editing
                if (currentTool) {
                    promptData.systemPrompts[currentTool] = document.getElementById('systemPrompt').value;
                    promptData.userPromptTemplates[currentTool] = document.getElementById('userPromptTemplate').value;
                }
                
                // Save to localStorage
                localStorage.setItem('ai_prompt_studio_data', JSON.stringify(promptData));
                
                // Update UI
                updateStorageStatus();
                setTimeout(() => {
                    alert('‚úÖ Prompts saved successfully to local storage!');
                    saveBtn.textContent = 'Save Prompts';
                    saveBtn.disabled = false;
                }, 300);
                
            } catch (error) {
                alert(`‚ùå Save Error: ${error.message}`);
                saveBtn.textContent = 'Save Prompts';
                saveBtn.disabled = false;
            }
        }
        
        function loadPromptsFromLocal() {
            const loadBtn = document.getElementById('loadBtn');
            if (loadBtn) {
                loadBtn.textContent = 'Loading...';
                loadBtn.disabled = true;
            }
            
            try {
                const savedData = localStorage.getItem('ai_prompt_studio_data');
                
                if (!savedData) {
                    console.log('No saved prompts found, using defaults');
                    if (loadBtn) {
                        loadBtn.textContent = 'Load Prompts';
                        loadBtn.disabled = false;
                    }
                    return;
                }
                
                const data = JSON.parse(savedData);
                
                // Load system prompts
                if (data.systemPrompts) {
                    Object.assign(systemPrompts, data.systemPrompts);
                }
                
                // Load user prompt templates
                if (data.userPromptTemplates) {
                    Object.assign(userPromptTemplates, data.userPromptTemplates);
                }
                
                // Load tone context
                if (data.toneContext && document.getElementById('toneContext')) {
                    document.getElementById('toneContext').value = data.toneContext;
                }
                
                // Refresh current tool display if we have a current tool
                if (currentTool) {
                    document.getElementById('systemPrompt').value = systemPrompts[currentTool];
                    document.getElementById('userPromptTemplate').value = userPromptTemplates[currentTool];
                }
                
                console.log('‚úÖ Prompts loaded successfully from local storage');
                
                if (loadBtn) {
                    setTimeout(() => {
                        alert('‚úÖ Prompts loaded successfully!');
                        loadBtn.textContent = 'Load Prompts';
                        loadBtn.disabled = false;
                    }, 300);
                }
                
            } catch (error) {
                console.error('Load Error:', error);
                if (loadBtn) {
                    alert(`‚ùå Load Error: ${error.message}`);
                    loadBtn.textContent = 'Load Prompts';
                    loadBtn.disabled = false;
                }
            }
        }
        
        function clearStoredPrompts() {
            if (confirm('‚ö†Ô∏è Are you sure you want to clear all stored prompts? This cannot be undone.')) {
                localStorage.removeItem('ai_prompt_studio_data');
                updateStorageStatus();
                
                // Reset to defaults
                Object.assign(systemPrompts, {
                    ideas: "You are a creative content strategist. Generate original, engaging content ideas.",
                    headlines: "You are a skilled copywriter. Create compelling, attention-grabbing headlines.",
                    summarize: "You are a professional editor. Create clear, concise summaries that capture key points.",
                    improve: "You are a writing coach. Enhance content while maintaining its original structure and meaning.",
                    seo: "You are an SEO specialist. Optimize content for search engines while keeping it readable and engaging."
                });
                
                Object.assign(userPromptTemplates, {
                    ideas: 'Generate 5 creative content ideas about: "{topic}"{tone_context}\n\nReturn ONLY a valid JSON array of strings:\n["idea 1", "idea 2", "idea 3", "idea 4", "idea 5"]',
                    headlines: 'Create 8 compelling headlines about: "{topic}"{tone_context}\n\nReturn ONLY a valid JSON array of strings:\n["headline 1", "headline 2", "headline 3", "headline 4", "headline 5", "headline 6", "headline 7", "headline 8"]',
                    summarize: 'Summarize the following content{tone_context}:\n\n{raw_content}\n\nReturn ONLY a JSON array with a single summary string:\n["Your comprehensive summary here"]',
                    improve: 'Improve and enhance the following content{tone_context}.\n\nYou can restructure, combine, split, or reorganize the content as needed for better readability and impact.\nYou may change the number of blocks and their types to improve the content structure.\n\nInput content blocks:\n{content_blocks_json}\n\nReturn ONLY a valid JSON array of enhanced content blocks. Each block must have:\n- type: "heading" | "text" | "quote" | "list"\n- content: string (or array of strings for lists)\n- level: number (1-6, only for headings)\n- author: string (only for quotes)\n- ordered: boolean (only for lists)\n\nExample valid block types:\n{"type": "heading", "content": "Enhanced Title", "level": 2}\n{"type": "text", "content": "Enhanced paragraph text"}\n{"type": "quote", "content": "Enhanced quote", "author": "Author Name"}\n{"type": "list", "content": ["Item 1", "Item 2"], "ordered": false}\n\nReturn the enhanced content as a valid JSON array:',
                    seo: 'Optimize for SEO the following content{tone_context}.\n\nYou can restructure, combine, split, or reorganize the content as needed for better search engine visibility and user engagement.\nYou may change the number of blocks and their types to improve the content structure.\n\nInput content blocks:\n{content_blocks_json}\n\nReturn ONLY a valid JSON array of SEO-optimized content blocks. Each block must have:\n- type: "heading" | "text" | "quote" | "list"\n- content: string (or array of strings for lists)\n- level: number (1-6, only for headings)\n- author: string (only for quotes)\n- ordered: boolean (only for lists)\n\nExample valid block types:\n{"type": "heading", "content": "SEO-Optimized Title with Keywords", "level": 2}\n{"type": "text", "content": "SEO-enhanced paragraph with relevant keywords"}\n{"type": "quote", "content": "Optimized quote", "author": "Author Name"}\n{"type": "list", "content": ["Keyword-rich item 1", "Keyword-rich item 2"], "ordered": false}\n\nReturn the SEO-optimized content as a valid JSON array:'
                });
                
                document.getElementById('toneContext').value = 'professional and engaging';
                
                // Refresh current tool display
                if (currentTool) {
                    document.getElementById('systemPrompt').value = systemPrompts[currentTool];
                    document.getElementById('userPromptTemplate').value = userPromptTemplates[currentTool];
                }
                
                alert('‚úÖ Storage cleared and prompts reset to defaults');
            }
        }
        
        // File-based Save/Load functionality
        function savePromptsToFile() {
            const saveBtn = document.getElementById('saveFileBtn');
            if (saveBtn) {
                saveBtn.textContent = 'Saving...';
                saveBtn.disabled = true;
            }
            
            try {
                // Update current tool's prompts before saving
                if (currentTool) {
                    systemPrompts[currentTool] = document.getElementById('systemPrompt').value;
                    userPromptTemplates[currentTool] = document.getElementById('userPromptTemplate').value;
                }
                
                // Prepare data for export
                const exportData = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    systemPrompts: systemPrompts,
                    userPromptTemplates: userPromptTemplates,
                    toneContext: document.getElementById('toneContext').value,
                    currentTool: currentTool
                };
                
                // Create JSON string
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // Create blob and download
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Create temporary download link
                const a = document.createElement('a');
                a.href = url;
                a.download = `ai-prompt-studio-config-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // Clean up URL
                URL.revokeObjectURL(url);
                
                console.log('‚úÖ Prompts exported to file successfully');
                
                if (saveBtn) {
                    setTimeout(() => {
                        alert('‚úÖ Prompts saved to file successfully!');
                        saveBtn.textContent = 'üíæ Save to File';
                        saveBtn.disabled = false;
                    }, 300);
                }
                
            } catch (error) {
                console.error('File Save Error:', error);
                if (saveBtn) {
                    alert(`‚ùå Save Error: ${error.message}`);
                    saveBtn.textContent = 'üíæ Save to File';
                    saveBtn.disabled = false;
                }
            }
        }
        
        function triggerLoadFile() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.click();
            }
        }
        
        function loadPromptsFromFile(event) {
            const loadBtn = document.getElementById('loadFileBtn');
            if (loadBtn) {
                loadBtn.textContent = 'Loading...';
                loadBtn.disabled = true;
            }
            
            const file = event.target.files[0];
            if (!file) {
                if (loadBtn) {
                    loadBtn.textContent = 'üìÅ Load from File';
                    loadBtn.disabled = false;
                }
                return;
            }
            
            // Check file type
            if (!file.name.endsWith('.json')) {
                alert('‚ùå Please select a JSON file');
                if (loadBtn) {
                    loadBtn.textContent = 'üìÅ Load from File';
                    loadBtn.disabled = false;
                }
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!data.systemPrompts || !data.userPromptTemplates) {
                        throw new Error('Invalid file format: missing required data');
                    }
                    
                    // Load system prompts
                    if (data.systemPrompts) {
                        Object.assign(systemPrompts, data.systemPrompts);
                    }
                    
                    // Load user prompt templates
                    if (data.userPromptTemplates) {
                        Object.assign(userPromptTemplates, data.userPromptTemplates);
                    }
                    
                    // Load tone context
                    if (data.toneContext && document.getElementById('toneContext')) {
                        document.getElementById('toneContext').value = data.toneContext;
                    }
                    
                    // Switch to the previously selected tool if available
                    if (data.currentTool && data.currentTool !== currentTool) {
                        selectTool(data.currentTool);
                    } else {
                        // Refresh current tool display
                        if (currentTool) {
                            document.getElementById('systemPrompt').value = systemPrompts[currentTool];
                            document.getElementById('userPromptTemplate').value = userPromptTemplates[currentTool];
                        }
                    }
                    
                    console.log('‚úÖ Prompts loaded successfully from file');
                    
                    if (loadBtn) {
                        setTimeout(() => {
                            alert('‚úÖ Prompts loaded successfully from file!');
                            loadBtn.textContent = 'üìÅ Load from File';
                            loadBtn.disabled = false;
                        }, 300);
                    }
                    
                    // Update storage status
                    updateStorageStatus();
                    
                } catch (error) {
                    console.error('File Load Error:', error);
                    if (loadBtn) {
                        alert(`‚ùå Load Error: ${error.message}`);
                        loadBtn.textContent = 'üìÅ Load from File';
                        loadBtn.disabled = false;
                    }
                }
            };
            
            reader.onerror = function() {
                console.error('File Read Error');
                if (loadBtn) {
                    alert('‚ùå Error reading file');
                    loadBtn.textContent = 'üìÅ Load from File';
                    loadBtn.disabled = false;
                }
            };
            
            reader.readAsText(file);
            
            // Clear the file input for next use
            event.target.value = '';
        }

        // Auto-save functionality
        let autoSaveTimeout;
        
        function debouncedAutoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                if (localStorage.getItem('ai_prompt_studio_data')) {
                    autoSaveCurrentPrompts();
                }
            }, 2000); // Auto-save after 2 seconds of inactivity
        }
        
        function autoSaveCurrentPrompts() {
            if (!currentTool) return;
            
            // Update the current tool's prompts in memory
            systemPrompts[currentTool] = document.getElementById('systemPrompt').value;
            userPromptTemplates[currentTool] = document.getElementById('userPromptTemplate').value;
            
            // Only auto-save if user has previously saved manually
            if (localStorage.getItem('ai_prompt_studio_data')) {
                savePromptsToLocal();
            }
        }
        
        async function testApiConnection() {
            if (!apiKey) {
                alert('Please enter your OpenAI API key first');
                return;
            }
            
            const testBtn = document.getElementById('testApiBtn');
            testBtn.textContent = 'Testing...';
            testBtn.disabled = true;
            
            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    updateApiStatus('Connected successfully', 'success');
                    alert('API connection successful!');
                } else {
                    const errorData = await response.json();
                    updateApiStatus('Connection failed', 'error');
                    alert(`API Error: ${errorData.error?.message || 'Unknown error'}`);
                }
            } catch (error) {
                updateApiStatus('Connection failed', 'error');
                alert(`Connection Error: ${error.message}`);
            } finally {
                testBtn.textContent = 'Test Connection';
                testBtn.disabled = false;
            }
        }
        
        // Real LLM API Call Function
        async function callOpenAI(systemPrompt, userPrompt) {
            if (!apiKey) {
                throw new Error('OpenAI API key not configured. Please add your API key in the configuration section.');
            }
            
            const model = document.getElementById('modelSelect') ? document.getElementById('modelSelect').value : 'gpt-4o-mini';
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: userPrompt }
                    ],
                    temperature: 0.7,
                    max_tokens: 1500
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${errorData.error?.message || 'Unknown error'}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        // Build user prompt from template
        function buildUserPrompt(template, userMessage) {
            let prompt = template;
            
            // Get tone context from input field
            const toneContextValue = document.getElementById('toneContext').value.trim();
            const formattedToneContext = toneContextValue ? ` in a ${toneContextValue} tone` : '';
            
            // Replace variables based on tool type
            const replacements = {
                '{topic}': userMessage,
                '{tone_context}': formattedToneContext,
                '{raw_content}': userMessage,
                '{content_blocks_json}': getContentBlocksJSON()
            };
            
            for (const [placeholder, value] of Object.entries(replacements)) {
                prompt = prompt.replace(new RegExp(placeholder.replace(/[{}]/g, '\\$&'), 'g'), value);
            }
            
            return prompt;
        }
        
        function getContentBlocksJSON() {
            const generatedJsonTextarea = document.getElementById('generatedJson');
            if (generatedJsonTextarea && generatedJsonTextarea.value.trim()) {
                return generatedJsonTextarea.value;
            }
            return JSON.stringify(contentBlocks, null, 2);
        }

        // Generate mock AI response
        function generateMockResponse(toolType, userMessage) {
            const responses = {
                ideas: [
                    "Create engaging Instagram story templates for small businesses",
                    "Design interactive polls about industry trends", 
                    "Share behind-the-scenes content from your workspace",
                    "Develop user-generated content campaigns",
                    "Create educational carousel posts explaining your process"
                ],
                headlines: [
                    "10 Proven Strategies to Boost Your Social Media Engagement",
                    "The Ultimate Guide to Content Marketing Success",
                    "How to Create Viral Content That Actually Converts",
                    "Social Media Trends Every Marketer Should Know in 2025",
                    "From Zero to Hero: Building Your Brand Online",
                    "The Psychology Behind Engaging Social Media Posts",
                    "Content Creation Secrets the Pros Don't Want You to Know",
                    "Transform Your Business with These Content Marketing Hacks"
                ],
                summarize: [
                    "This content explores the fundamentals of social media marketing, covering key strategies for audience engagement, platform optimization, and measurable results through consistent posting and community interaction."
                ],
                improve: [
                    {"type": "heading", "content": "Enhanced Digital Marketing Strategy", "level": 1},
                    {"type": "text", "content": "Social media marketing has evolved into a sophisticated discipline that requires strategic planning, consistent execution, and data-driven optimization to achieve meaningful business results."},
                    {"type": "list", "content": ["Develop comprehensive content calendars", "Implement advanced analytics tracking", "Create authentic engagement strategies"], "ordered": false}
                ],
                seo: [
                    {"type": "heading", "content": "Professional Digital Marketing Services | SEO & Social Media Solutions", "level": 1},
                    {"type": "text", "content": "Our comprehensive digital marketing services help businesses achieve sustainable online growth through strategic SEO optimization, targeted social media campaigns, and data-driven content marketing strategies."},
                    {"type": "list", "content": ["SEO-optimized content creation", "Strategic keyword implementation", "Performance tracking and analytics"], "ordered": true}
                ]
            };
            
            // Sometimes return intentionally malformed responses for testing
            if (Math.random() < 0.3) {
                return generateMalformedResponse(toolType);
            }
            
            return JSON.stringify(responses[toolType], null, 2);
        }

        // Generate malformed responses for testing validation
        function generateMalformedResponse(toolType) {
            const malformed = {
                ideas: '["idea 1", "idea 2", "idea 3"]', // Wrong count
                headlines: '"Just a single headline"', // Not an array
                summarize: '["summary 1", "summary 2"]', // Too many items
                improve: '[{"type": "paragraph", "content": "wrong type"}]', // Invalid type
                seo: '[{"type": "text"}]' // Missing content
            };
            
            return malformed[toolType] || '"Invalid response"';
        }

        // Validate AI response
        function validateResponse(toolType, responseText) {
            try {
                const response = JSON.parse(responseText);
                
                if (!Array.isArray(response)) {
                    return { isValid: false, error: 'Response is not an array' };
                }
                
                switch (toolType) {
                    case 'ideas':
                        return validateSimpleArray(response, 5, 'ideas');
                    case 'headlines':
                        return validateSimpleArray(response, 8, 'headlines');
                    case 'summarize':
                        return validateSimpleArray(response, 1, 'summary');
                    case 'improve':
                    case 'seo':
                        return validateContentBlocks(response);
                    default:
                        return { isValid: false, error: 'Unknown tool type' };
                }
            } catch (error) {
                return { isValid: false, error: 'Invalid JSON format' };
            }
        }

        function validateSimpleArray(array, expectedLength, type) {
            if (array.length !== expectedLength) {
                return { isValid: false, error: `Expected ${expectedLength} ${type}, got ${array.length}` };
            }
            
            for (let i = 0; i < array.length; i++) {
                if (typeof array[i] !== 'string' || !array[i].trim()) {
                    return { isValid: false, error: `Item ${i + 1} is not a valid string` };
                }
            }
            
            return { isValid: true };
        }

        function validateContentBlocks(blocks) {
            if (blocks.length === 0) {
                return { isValid: false, error: 'No content blocks found' };
            }
            
            const validTypes = ['heading', 'text', 'quote', 'list'];
            
            for (let i = 0; i < blocks.length; i++) {
                const block = blocks[i];
                
                if (!block.type || !validTypes.includes(block.type)) {
                    return { isValid: false, error: `Block ${i + 1} has invalid type: ${block.type}` };
                }
                
                if (!block.content) {
                    return { isValid: false, error: `Block ${i + 1} has no content` };
                }
                
                // Validate specific requirements
                if (block.type === 'heading' && (typeof block.level !== 'number' || block.level < 1 || block.level > 6)) {
                    return { isValid: false, error: `Block ${i + 1} heading has invalid level` };
                }
                
                if (block.type === 'list' && !Array.isArray(block.content)) {
                    return { isValid: false, error: `Block ${i + 1} list content must be array` };
                }
            }
            
            return { isValid: true };
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function handleKeyDown(event) {
            if (event.ctrlKey && event.key === 'Enter') {
                sendMessage();
            }
        }

        function setExample(text) {
            document.getElementById('userInput').value = text;
        }

        function clearChat() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <p>Chat cleared. Start testing your prompts!</p>
                </div>
            `;
            messageCount = 0;
        }

        // Initialize with ideas tool
        selectTool('ideas');
    </script>
</body>
</html>
